{
  "name": "PI Loop Prediction Pipeline",
  "description": "MLOps Pipeline: Executes daily ML.PREDICT with macro-feature JOIN and sends high-confidence churn alerts.",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours",
              "value": 24
            }
          ]
        }
      },
      "name": "Schedule Trigger (24h)",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1,
      "id": "B1"
    },
    {
      "parameters": {
        "query": "-- PI_Loop BTC: BQML Production Prediction SQL (Executed by n8n daily)\n\nSELECT\n  t1.wallet_id,\n  t1.current_hash_power_ghs,\n  predictions.predicted_churn_30_day_label,\n  predictions.probability_of_churn\nFROM\n  `pi_loop_data.user_transaction_data` AS t1\nJOIN\n  `pi_loop_data.global_mining_features` AS t2\nON\n  t2.feature_date = (SELECT MAX(feature_date) FROM `pi_loop_data.global_mining_features`)\nLEFT JOIN\n  ML.PREDICT(MODEL `pi_loop.churn_prediction_model`, (\n    -- The prediction input features must exactly match the features used for training:\n    SELECT\n      t1.days_since_last_login,\n      t1.current_hash_power_ghs,\n      t1.profit_withdrawal_count,\n      t2.mining_profitability_index\n    FROM\n      `pi_loop_data.user_transaction_data` AS t1\n    WHERE\n      t1.contract_status = 'active'\n  )) AS predictions\nON\n  t1.wallet_id = predictions.wallet_id\nWHERE\n  predictions.predicted_churn_30_day_label = 1\n  AND predictions.probability_of_churn > 0.75; -- Only alert for high-confidence churn predictions",
        "options": {}
      },
      "name": "Execute ML.PREDICT (SQL)",
      "type": "n8n-nodes-google.bigQuery",
      "typeVersion": 2,
      "id": "B2",
      "position": [
        400,
        450
      ],
      "connections": {
        "main": [
          [
            {
              "node": "Check High Risk Churn",
              "type": "main",
              "index": 0
            }
          ]
        ]
      }
    },
    {
      "parameters": {
        "body": "\ud83d\udea8 CHURN ALERT: Wallet ID: {{ $json.wallet_id }}. Hash Power: {{ $json.current_hash_power_ghs }}. Probability: {{ $json.predictions.probability_of_churn | round(2) }}.",
        "options": {
          "channel": "#retention-alerts"
        }
      },
      "name": "Send Alert to Retention Team",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 1,
      "id": "B4",
      "position": [
        900,
        450
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "{{(() => {\n  const p = $json?.predictions?.probability_of_churn;\n  return typeof p === 'number' && p > 0.75;\n})()}}"
            }
          ]
        }
      },
      "name": "Check High Risk Churn",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        700,
        300
      ],
      "id": "B5",
      "connections": {
        "main": [
          [
            {
              "node": "Send Alert to Retention Team",
              "type": "main",
              "index": 0
            }
          ],
          []
        ]
      }
    }
  ],
  "connections": {
    "B1": {
      "main": [
        [
          {
            "node": "B2",
            "index": 0
          }
        ]
      ]
    },
    "B2": {
      "main": [
        [
          {
            "node": "B3",
            "index": 0
          }
        ]
      ]
    },
    "B3": {
      "main": [
        [
          {
            "node": "B4",
            "index": 0
          }
        ]
      ]
    }
  }
}